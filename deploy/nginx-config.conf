# WordPress Templates Catalog - Nginx Configuration
# Add this to Plesk > Apache & nginx Settings > Additional nginx directives

# Serve WordPress sites directly from /srv/templates/{slug}/httpdocs
location ~ ^/([a-zA-Z0-9\-_]+)/?(.*)$ {
    set $wp_root "/srv/templates/$1/httpdocs";
    
    # Check if the WordPress directory exists
    if (-d $wp_root) {
        root $wp_root;
        
        # Try to serve the file, then directory, then WordPress index.php
        try_files /$2 /$2/ /index.php?$args;
        
        # Handle PHP files for WordPress
        location ~ \.php$ {
            try_files $uri =404;
            
            include fastcgi_params;
            fastcgi_param SCRIPT_FILENAME $wp_root$fastcgi_script_name;
            fastcgi_param DOCUMENT_ROOT $wp_root;
            
            # Adjust the PHP-FPM socket path for your domain
            # Replace 'your-domain.com' with your actual domain
            fastcgi_pass unix:/var/www/vhosts/system/your-domain.com/php-fpm.sock;
            
            # Additional security headers
            fastcgi_param HTTP_PROXY "";
            fastcgi_param SERVER_NAME $host;
            fastcgi_param REQUEST_SCHEME $scheme;
        }
        
        # Security: deny access to sensitive files
        location ~ /\.(htaccess|htpasswd|svn|git) {
            deny all;
        }
        
        location ~ /wp-config\.php {
            deny all;
        }
        
        # Break out of location processing
        break;
    }
}

# Security headers for the main application
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;

# Cache static assets
location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
    access_log off;
}

# Cache screenshots with longer expiration
location /storage/screenshots/ {
    expires 7d;
    add_header Cache-Control "public";
    access_log off;
}

# Security: deny access to sensitive Laravel directories
location ~ /\.(env|git) {
    deny all;
    return 404;
}

location ~ /(storage/app|storage/framework|storage/logs|bootstrap/cache) {
    deny all;
    return 404;
}

# Increase client body size for API uploads
client_max_body_size 32M;

# Timeout settings for screenshot generation
proxy_connect_timeout 60s;
proxy_send_timeout 60s;
proxy_read_timeout 60s;