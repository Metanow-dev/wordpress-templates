# WordPress Templates - Nginx Configuration for Plesk
# Add this to: Plesk → Websites & Domains → wp-templates.metanow.dev → Apache & nginx Settings
# In "Additional nginx directives" section

# Serve WordPress template sites directly from templates directory
location ~ ^/([a-zA-Z0-9\-_]+)/?(.*)$ {
    set $template_name $1;
    set $template_path $2;
    
    # Try multiple WordPress structures
    set $template_root "";
    set $wp_config_check "";
    
    # Check for httpdocs structure (Plesk clones)
    set $wp_config_check "/var/www/vhosts/wp-templates.metanow.dev/httpdocs/templates/$template_name/httpdocs/wp-config.php";
    if (-f $wp_config_check) {
        set $template_root "/var/www/vhosts/wp-templates.metanow.dev/httpdocs/templates/$template_name/httpdocs";
    }
    
    # Check for public structure
    if ($template_root = "") {
        set $wp_config_check "/var/www/vhosts/wp-templates.metanow.dev/httpdocs/templates/$template_name/public/wp-config.php";
        if (-f $wp_config_check) {
            set $template_root "/var/www/vhosts/wp-templates.metanow.dev/httpdocs/templates/$template_name/public";
        }
    }
    
    # Check for root structure
    if ($template_root = "") {
        set $wp_config_check "/var/www/vhosts/wp-templates.metanow.dev/httpdocs/templates/$template_name/wp-config.php";
        if (-f $wp_config_check) {
            set $template_root "/var/www/vhosts/wp-templates.metanow.dev/httpdocs/templates/$template_name";
        }
    }
    
    # If valid WordPress template found, serve it
    if ($template_root != "") {
        root $template_root;
        index index.php index.html;
        
        # Handle empty path or try files
        if ($template_path = "") {
            try_files /index.php /index.html =404;
        }
        if ($template_path != "") {
            try_files /$template_path /$template_path/ /index.php?$args;
        }
        
        # PHP handling
        location ~ \.php$ {
            try_files $uri =404;
            include fastcgi_params;
            fastcgi_param SCRIPT_FILENAME $template_root$fastcgi_script_name;
            fastcgi_param DOCUMENT_ROOT $template_root;
            fastcgi_pass unix:/var/run/php/php8.3-fpm.sock;  # Adjust PHP version as needed
        }
        
        break;
    }
}

# Security: Block access to sensitive files in templates
location ~ ^/[^/]+/(wp-config\.php|\.env|\.git) {
    deny all;
    return 404;
}