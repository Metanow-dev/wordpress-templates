name: Deploy to Plesk Production

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Allow manual triggering

env:
  NODE_VERSION: '18'
  PHP_VERSION: '8.3'

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ env.PHP_VERSION }}
        extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv
        coverage: none
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install Composer dependencies
      run: composer install --no-dev --no-interaction --prefer-dist --optimize-autoloader --no-progress
      
    - name: Install NPM dependencies
      run: npm ci --production=false
      
    - name: Build assets
      run: npm run build
      
    - name: Create deployment archive
      run: |
        # Create deployment directory
        mkdir -p deployment-build
        
        # Copy files to deployment directory (avoids "file changed" issues)
        rsync -av \
          --exclude='.git/' \
          --exclude='.github/' \
          --exclude='node_modules/' \
          --exclude='tests/' \
          --exclude='storage/app/' \
          --exclude='storage/framework/cache/' \
          --exclude='storage/framework/sessions/' \
          --exclude='storage/framework/testing/' \
          --exclude='storage/framework/views/' \
          --exclude='storage/logs/' \
          --exclude='.env' \
          --exclude='.env.example' \
          --exclude='deployment-build/' \
          ./ deployment-build/
        
        # Create archive from copied files
        cd deployment-build
        tar -czf ../deployment.tar.gz .
        cd ..
        
        # Cleanup
        rm -rf deployment-build
            
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.PLESK_HOST }}
        username: ${{ secrets.PLESK_USERNAME }}
        key: ${{ secrets.PLESK_SSH_KEY }}
        port: ${{ secrets.PLESK_SSH_PORT || 22 }}
        script_stop: true
        script: |
          set -e
          
          # Configuration
          APP_PATH="/var/www/vhosts/${{ secrets.DOMAIN_NAME }}/httpdocs"
          BACKUP_PATH="/var/www/vhosts/${{ secrets.DOMAIN_NAME }}/backups/$(date +%Y%m%d_%H%M%S)"
          
          echo "üöÄ Starting deployment to $APP_PATH"
          
          # Create backup directory
          mkdir -p "$(dirname "$BACKUP_PATH")"
          
          # Backup current deployment (if exists)
          if [ -d "$APP_PATH" ]; then
            echo "üì¶ Creating backup..."
            cp -r "$APP_PATH" "$BACKUP_PATH"
            echo "‚úÖ Backup created at $BACKUP_PATH"
          fi
          
          # Create application directory
          mkdir -p "$APP_PATH"
          cd "$APP_PATH"
          
          # Download and extract deployment
          echo "‚¨áÔ∏è  Downloading deployment archive..."
          
    - name: Upload and extract deployment
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.PLESK_HOST }}
        username: ${{ secrets.PLESK_USERNAME }}
        key: ${{ secrets.PLESK_SSH_KEY }}
        port: ${{ secrets.PLESK_SSH_PORT || 22 }}
        source: "deployment.tar.gz"
        target: "/var/www/vhosts/${{ secrets.DOMAIN_NAME }}/httpdocs/"
        
    - name: Complete deployment
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.PLESK_HOST }}
        username: ${{ secrets.PLESK_USERNAME }}
        key: ${{ secrets.PLESK_SSH_KEY }}
        port: ${{ secrets.PLESK_SSH_PORT || 22 }}
        script: |
          set -e
          
          APP_PATH="/var/www/vhosts/${{ secrets.DOMAIN_NAME }}/httpdocs"
          cd "$APP_PATH"
          
          # Extract deployment
          echo "üì§ Extracting deployment..."
          tar -xzf deployment.tar.gz
          rm deployment.tar.gz
          
          # Create Laravel directory structure
          echo "üìÅ Creating Laravel directories..."
          mkdir -p storage/{app,framework/{cache,sessions,testing,views},logs}
          mkdir -p bootstrap/cache
          touch storage/logs/laravel.log
          
          # Set permissions
          echo "üîí Setting permissions..."
          find . -type f -exec chmod 644 {} \;
          find . -type d -exec chmod 755 {} \;
          chmod -R 775 storage bootstrap/cache
          
          # Detect and set correct web user (CloudLinux/CentOS uses apache, Ubuntu uses www-data)
          if id -u apache >/dev/null 2>&1; then
            echo "Using apache:apache ownership"
            chown -R apache:apache storage bootstrap/cache
          elif id -u www-data >/dev/null 2>&1; then
            echo "Using www-data:www-data ownership"
            chown -R www-data:www-data storage bootstrap/cache
          elif id -u nginx >/dev/null 2>&1; then
            echo "Using nginx:nginx ownership"
            chown -R nginx:nginx storage bootstrap/cache
          else
            echo "‚ö†Ô∏è  Could not detect web user, skipping chown"
          fi
          
          # Laravel deployment commands
          echo "‚ö° Running Laravel commands..."
          
          # Detect PHP binary path
          if [ -x "/opt/plesk/php/8.3/bin/php" ]; then
            PHP_BIN="/opt/plesk/php/8.3/bin/php"
            echo "Using PHP 8.3: $PHP_BIN"
          elif [ -x "/opt/plesk/php/8.2/bin/php" ]; then
            PHP_BIN="/opt/plesk/php/8.2/bin/php"
            echo "Using PHP 8.2: $PHP_BIN"
          elif [ -x "/opt/plesk/php/8.1/bin/php" ]; then
            PHP_BIN="/opt/plesk/php/8.1/bin/php"
            echo "Using PHP 8.1: $PHP_BIN"
          elif command -v php >/dev/null 2>&1; then
            PHP_BIN="php"
            echo "Using system PHP: $(php --version | head -n1)"
          else
            echo "‚ùå PHP not found!"
            exit 1
          fi
          
          # Create .env file from secrets (without script_stop interference)
          echo "üìù Creating .env file..."
          echo 'APP_NAME="WordPress Templates Catalog"' > .env
          echo 'APP_ENV=production' >> .env
          echo 'APP_KEY=' >> .env
          echo 'APP_DEBUG=false' >> .env
          echo 'APP_URL=${{ secrets.APP_URL }}' >> .env
          echo 'APP_TIMEZONE=Europe/Berlin' >> .env
          echo '' >> .env
          echo 'DB_CONNECTION=mysql' >> .env
          echo 'DB_HOST=${{ secrets.DB_HOST }}' >> .env
          echo 'DB_PORT=3306' >> .env
          echo 'DB_DATABASE=${{ secrets.DB_DATABASE }}' >> .env
          echo 'DB_USERNAME=${{ secrets.DB_USERNAME }}' >> .env
          echo 'DB_PASSWORD=${{ secrets.DB_PASSWORD }}' >> .env
          echo '' >> .env
          echo 'TEMPLATES_ROOT=/srv/templates' >> .env
          echo 'DEMO_URL_PATTERN=${{ secrets.APP_URL }}/{slug}/' >> .env
          echo '' >> .env
          echo 'CHROME_BINARY_PATH=/usr/bin/google-chrome-stable' >> .env
          echo 'NODE_BINARY_PATH=/usr/bin/node' >> .env
          echo 'SCREENSHOT_TIMEOUT=30000' >> .env
          echo 'SCREENSHOT_WAIT_FOR_NETWORK_IDLE=true' >> .env
          echo 'SCREENSHOT_DELAY=700' >> .env
          echo '' >> .env
          echo 'API_TOKEN=${{ secrets.API_TOKEN }}' >> .env
          echo '' >> .env
          echo 'CACHE_DRIVER=file' >> .env
          echo 'SESSION_DRIVER=file' >> .env
          echo 'SESSION_LIFETIME=120' >> .env
          echo 'QUEUE_CONNECTION=sync' >> .env
          echo '' >> .env
          echo 'LOG_CHANNEL=daily' >> .env
          echo 'LOG_LEVEL=error' >> .env
          echo '' >> .env
          echo 'DEFAULT_LOCALE=en' >> .env
          echo 'FALLBACK_LOCALE=en' >> .env
          echo '' >> .env
          echo 'PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true' >> .env
          echo 'PUPPETEER_EXECUTABLE_PATH=/usr/bin/google-chrome-stable' >> .env
          
          # Generate application key
          $PHP_BIN artisan key:generate --force
          
          # Cache configuration and routes
          $PHP_BIN artisan config:cache
          $PHP_BIN artisan route:cache
          $PHP_BIN artisan view:cache
          
          # Run database migrations
          $PHP_BIN artisan migrate --force --no-interaction
          
          # Link storage
          $PHP_BIN artisan storage:link
          
          # Restart queues if running
          $PHP_BIN artisan queue:restart || true
          
          # Clear application cache
          $PHP_BIN artisan cache:clear
          
          # Run post-deployment setup
          echo "üîß Running post-deployment setup..."
          chmod +x deploy/post-deploy-setup.sh
          APP_PATH="$APP_PATH" ./deploy/post-deploy-setup.sh
          
          echo "‚úÖ Deployment completed successfully!"
          
          # Test the application
          echo "üß™ Testing application..."
          
          # Try HTTPS first, then HTTP as fallback
          if curl -f -s -o /dev/null https://${{ secrets.DOMAIN_NAME }}/en/templates; then
            echo "‚úÖ Application is responding correctly on HTTPS!"
          elif curl -f -s -o /dev/null http://${{ secrets.DOMAIN_NAME }}/en/templates; then
            echo "‚úÖ Application is responding correctly on HTTP!"
            echo "‚ö†Ô∏è  Note: HTTPS may need SSL certificate setup"
          else
            echo "‚ö†Ô∏è  HTTP test failed, trying basic Laravel route..."
            # Test if Laravel is working at all
            if curl -f -s -o /dev/null http://${{ secrets.DOMAIN_NAME }}/; then
              echo "‚úÖ Laravel is running, but templates route may need configuration"
            else
              echo "‚ùå Application is not responding. Check logs:"
              echo "- Application logs: storage/logs/"
              echo "- Web server logs: /var/log/"
              # Don't fail deployment for this - app is deployed successfully
            fi
          fi
          
  post-deploy:
    name: Post-deployment tasks
    runs-on: ubuntu-latest
    needs: deploy
    if: success()
    
    steps:
    - name: Trigger template scan
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.PLESK_HOST }}
        username: ${{ secrets.PLESK_USERNAME }}
        key: ${{ secrets.PLESK_SSH_KEY }}
        port: ${{ secrets.PLESK_SSH_PORT || 22 }}
        script: |
          APP_PATH="/var/www/vhosts/${{ secrets.DOMAIN_NAME }}/httpdocs"
          cd "$APP_PATH"
          
          # Detect PHP binary path
          if [ -x "/opt/plesk/php/8.3/bin/php" ]; then
            PHP_BIN="/opt/plesk/php/8.3/bin/php"
          elif [ -x "/opt/plesk/php/8.2/bin/php" ]; then
            PHP_BIN="/opt/plesk/php/8.2/bin/php"
          elif [ -x "/opt/plesk/php/8.1/bin/php" ]; then
            PHP_BIN="/opt/plesk/php/8.1/bin/php"
          elif command -v php >/dev/null 2>&1; then
            PHP_BIN="php"
          else
            echo "‚ùå PHP not found!"
            exit 1
          fi
          
          echo "üîç Running template scan..."
          $PHP_BIN artisan templates:scan
          
          echo "üì∏ Updating screenshots..."
          $PHP_BIN artisan templates:screenshot --timeout=300
          
          echo "‚úÖ Post-deployment tasks completed!"
          
    - name: Cleanup old backups
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.PLESK_HOST }}
        username: ${{ secrets.PLESK_USERNAME }}
        key: ${{ secrets.PLESK_SSH_KEY }}
        port: ${{ secrets.PLESK_SSH_PORT || 22 }}
        script: |
          BACKUP_DIR="/var/www/vhosts/${{ secrets.DOMAIN_NAME }}/backups"
          
          if [ -d "$BACKUP_DIR" ]; then
            echo "üßπ Cleaning up old backups (keeping last 5)..."
            cd "$BACKUP_DIR"
            ls -t | tail -n +6 | xargs -r rm -rf
            echo "‚úÖ Backup cleanup completed!"
          fi